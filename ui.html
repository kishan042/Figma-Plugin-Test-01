<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Generate brand variants</title>
<style>
  body {
    font-family: Inter, sans-serif;
    font-size: 13px;
    color: #222;
    margin: 0;
    padding: 16px;
    background: #fff;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  h1 {
    font-size: 14px;
    font-weight: 600;
    margin: 0 0 8px 0;
  }
  fieldset {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 8px 12px;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  legend {
    font-weight: 500;
    padding: 0 4px;
  }
  .brand-list {
    max-height: 160px;
    overflow-y: auto;
    padding: 4px;
    border: 1px solid #eee;
    border-radius: 4px;
  }
  .brand-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }
  .brand-label {
    display: flex;
    flex-direction: column;
    gap: 2px;
    margin-left: 8px;
  }
  .brand-id {
    font-size: 11px;
    color: #666;
  }
  .switch {
    position: relative;
    display: inline-block;
    width: 34px;
    height: 20px;
  }
  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.2s;
    border-radius: 34px;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 14px;
    width: 14px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.2s;
    border-radius: 50%;
  }
  .switch input:checked + .slider {
    background-color: #007aff;
  }
  .switch input:checked + .slider:before {
    transform: translateX(14px);
  }
  .controls {
    display: flex;
    justify-content: space-between;
    margin-top: 4px;
  }
  button {
    border: none;
    border-radius: 4px;
    padding: 6px 12px;
    font-size: 13px;
    cursor: pointer;
  }
  button:disabled {
    opacity: 0.6;
    cursor: default;
  }
  .primary {
    background: #007aff;
    color: #fff;
  }
  .secondary {
    background: #f3f3f3;
  }
  .status {
    font-size: 12px;
    margin-top: 6px;
  }
  .error {
    color: #d00;
  }
  .muted {
    color: #666;
  }
</style>
</head>
<body>
  <h1>Generate brand variants</h1>
  <fieldset>
    <legend>Brands found</legend>
    <div id="brandList" class="brand-list muted">Detecting brands…</div>
    <div class="controls">
      <button id="selectAll" class="secondary" disabled>Select all</button>
      <button id="deselectAll" class="secondary" disabled>Deselect all</button>
    </div>
  </fieldset>
  <div class="controls">
    <button id="generateBtn" class="primary" disabled>Generate</button>
    <button id="closeBtn" class="secondary">Close</button>
  </div>
  <div id="status" class="status muted">Detecting brands…</div>
<script>
  const brandListEl = document.getElementById('brandList');
  const selectAllBtn = document.getElementById('selectAll');
  const deselectAllBtn = document.getElementById('deselectAll');
  const generateBtn = document.getElementById('generateBtn');
  const closeBtn = document.getElementById('closeBtn');
  const statusEl = document.getElementById('status');

  let brands = [];
  let selected = new Set();

  function postToPlugin(action, payload = {}) {
    parent.postMessage({ pluginMessage: { type: 'UI_TO_PLUGIN', action, ...payload } }, '*');
  }

  function renderBrands() {
    brandListEl.innerHTML = '';
    if (!brands.length) {
      brandListEl.textContent =
        'No variable collections detected, please set up brand collections, then retry.';
      brandListEl.classList.add('muted');
      generateBtn.disabled = true;
      selectAllBtn.disabled = true;
      deselectAllBtn.disabled = true;
      return;
    }
    brandListEl.classList.remove('muted');

    brands.forEach((b) => {
      const id = `brand-${b.id}`;
      const wrapper = document.createElement('div');
      wrapper.className = 'brand-item';

      const switchLabel = document.createElement('label');
      switchLabel.className = 'switch';
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = id;
      checkbox.value = b.id;
      checkbox.checked = selected.has(b.id);
      const slider = document.createElement('span');
      slider.className = 'slider';
      switchLabel.appendChild(checkbox);
      switchLabel.appendChild(slider);

      checkbox.addEventListener('change', () => {
        if (checkbox.checked) selected.add(b.id);
        else selected.delete(b.id);
        updateGenerateState();
      });

      const infoLabel = document.createElement('label');
      infoLabel.className = 'brand-label';
      infoLabel.htmlFor = id;
      infoLabel.innerHTML = `<span>${b.name}</span><span class="brand-id">${b.id}</span>`;

      wrapper.appendChild(switchLabel);
      wrapper.appendChild(infoLabel);
      brandListEl.appendChild(wrapper);
    });

    selectAllBtn.disabled = false;
    deselectAllBtn.disabled = false;
    updateGenerateState();
  }

  function updateGenerateState() {
    generateBtn.disabled = selected.size === 0;
  }

  selectAllBtn.onclick = () => {
    brands.forEach((b) => selected.add(b.id));
    renderBrands();
  };

  deselectAllBtn.onclick = () => {
    selected.clear();
    renderBrands();
  };

  generateBtn.onclick = () => {
    generateBtn.disabled = true;
    selectAllBtn.disabled = true;
    deselectAllBtn.disabled = true;
    statusEl.textContent = `Generating ${selected.size} variants…`;
    postToPlugin('GENERATE', { selectedBrandIds: Array.from(selected) });
  };

  closeBtn.onclick = () => postToPlugin('CLOSE');

  window.onmessage = (event) => {
    const msg = event.data.pluginMessage;
    if (!msg || msg.type !== 'PLUGIN_TO_UI') return;

    switch (msg.action) {
      case 'BRANDS_LIST':
        brands = msg.brands || [];
        selected.clear();
        statusEl.textContent = brands.length
          ? 'Ready'
          : 'No variable collections detected.';
        renderBrands();
        break;
      case 'PROGRESS':
        statusEl.textContent = msg.message;
        break;
      case 'DONE':
        statusEl.textContent = `Done, created ${msg.createdCount} frames.`;
        generateBtn.disabled = false;
        selectAllBtn.disabled = false;
        deselectAllBtn.disabled = false;
        break;
      case 'ERROR':
        statusEl.textContent = msg.message;
        statusEl.classList.add('error');
        generateBtn.disabled = false;
        selectAllBtn.disabled = false;
        deselectAllBtn.disabled = false;
        break;
    }
  };

  // Initial request to get brand collections
  postToPlugin('REQUEST_BRANDS');
</script>
</body>
</html>
